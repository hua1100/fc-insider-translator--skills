# 智能匹配功能使用指南

## 🎯 问题解决

**你遇到的问题**：新翻译的顺序与原始 Markdown 表格不一致，导致映射错乱。

**解决方案**：使用 `--match-by smart` 智能匹配模式！

---

## ✨ 智能匹配如何工作

智能匹配使用**文本相似度算法**自动找到最佳配对，即使顺序完全不同也能正确匹配！

### 相似度计算方法

综合使用三种方法：

1. **序列相似度** (权重 50%)
   - 使用 Python 的 SequenceMatcher
   - 考虑字符序列的匹配程度

2. **共同字符比例** (权重 20%)
   - 计算两段文本共有的字符
   - 适合检测整体词汇相似性

3. **词汇重叠度** (权重 30%)
   - 比较共同词汇的数量
   - 对翻译风格差异有较好的容错性

### 匹配算法

使用**贪婪匹配算法**：
1. 计算所有可能配对的相似度
2. 按相似度从高到低排序
3. 依次选择最佳配对（确保每个翻译只被使用一次）

---

## 🚀 使用方法

### 完整命令

```bash
python3 ../scripts/generate_translation_mapping.py \
  --markdown extracted_table.md \
  --new-translations new_translations.txt \
  --output translations.json \
  --match-by smart \
  --verbose
```

### 关键参数

- `--match-by smart` - 使用智能匹配（**关键！**）
- `--verbose` - 显示详细的匹配信息（**强烈推荐**）

---

## 📊 输出示例

```
================================================================================
生成翻译对照表
================================================================================

读取 Markdown 表格: extracted_table.md
✓ 加载 26 行

占位符过滤:
  总行数: 26
  保留: 15
  跳过: 11

✓ 过滤后保留 15 行（跳过了占位符行）

读取新译文: new_translations.txt
✓ 加载 15 个译文

🔍 智能匹配模式
   旧翻译数量: 15
   新翻译数量: 15
   最小相似度阈值: 15%
✓ 智能匹配完成：15 个配对

匹配示例（按相似度排序，前5个）:

  1. 相似度: 87.34%
     旧: PY26 已至，作為全球政策諮詢委員領導者，您在助力團隊與事業實現本年...
     新: PY26 正式啟動！作為創辦人理事會領袖，您在帶領團隊與事業邁向成...

  2. 相似度: 82.15%
     旧: 您是團隊的榜樣，而 Amway 也準備了令人振奮的更新與最佳化，讓團隊...
     新: 您是團隊的榜樣。為協助您更輕鬆且更有成就感地領導團隊，安麗今...

  3. 相似度: 78.92%
     旧: 聆聽 Amway 市場總裁 John Parker 為考評年度拉開序幕的致辭。
     新: 請聆聽安麗市場事業總裁 John Parker 的開場致詞，為新績效年...

  4. 相似度: 75.43%
     旧: 全球職級認承方案最佳化
     新: 全球獎勵認可（GAR）制度強化

  5. 相似度: 71.28%
     旧: 得益於您的回饋與建議，全球職級認承方案現已升級，體驗更勝以往！
     新: 感謝您的寶貴回饋與建議，GAR 現在比以往更完善。

生成对照表（匹配方式: smart）...
✓ 生成 15 个变更

✓ 验证通过
```

---

## ⚠️ 相似度警告

如果某些配对的相似度过低（< 15%），会显示警告：

```
⚠️  警告：2 个配对的相似度较低（< 15%）
   建议检查这些配对是否正确：

   1. 相似度: 12.34%
      旧: 2025 年 9 月 // 第 8 期
      新: 2025/9/8 新財年，新希望！

   2. 相似度: 8.76%
      旧: 立即觀看
      新: 立即收看
```

**建议**：检查这些低相似度的配对，确认是否正确。

---

## 🆚 三种匹配方式对比

| 特性 | `index` | `segment_id` | **`smart`** |
|------|---------|--------------|-------------|
| **顺序依赖** | 必须一致 | 无关（需JSON） | **无关** ✅ |
| **文件格式** | 纯文本 | JSON | **纯文本** ✅ |
| **准备难度** | 简单 | 复杂 | **简单** ✅ |
| **容错能力** | ❌ 无 | ❌ 无 | **✅ 有** |
| **自动匹配** | ❌ 无 | ❌ 无 | **✅ 有** |
| **适用场景** | 顺序完全一致 | 有segment_id | **顺序不一致** ✅ |
| **推荐度** | ⭐⭐⭐ | ⭐⭐⭐⭐ | **⭐⭐⭐⭐⭐** |

---

## 📋 完整工作流程

### 步骤 1: 提取表格

```bash
python3 ../scripts/extract_table_markitdown_simple.py \
  --input "/Users/hua/md腳本/FCInsider_Dec2025_Issue9_翻譯修訂版.docx" \
  --output extracted_table.md
```

### 步骤 2: 准备新翻译（任意顺序）

创建 `new_translations.txt`，**顺序可以不一致**：

```txt
2025/9/8 新財年，新希望！
PY26 正式啟動！作為創辦人理事會領袖，您在帶領團隊與事業邁向成功的過程中，扮演著舉足輕重的角色。
您是團隊的榜樣。為協助您更輕鬆且更有成就感地領導團隊，安麗今年推出了多項令人振奮的最新方案與優化措施。
請聆聽安麗市場事業總裁 John Parker 的開場致詞，為新績效年度揭開序幕。
接著，請繼續閱讀以下內容，了解如何在新年度開創佳績，其中包含獎勵提醒、培訓更新，以及 2026 年創辦人理事會的精彩預告。
全球獎勵認可（GAR）制度強化
感謝您的寶貴回饋與建議，GAR 現在比以往更完善。
我們深知，協助下線領袖成長需要時間、努力與全心投入，您理應因這份付出而獲得應有的肯定與獎勵。
因此，自今年起，白金資格者將可同時在寬度與深度上為您的 GAR 資格貢獻計算。
自雙鑽以上級別起，每一條白金腿可計入寬度統計。
白金下線資格者可為您貢獻 0.5 個資格積分（Qualification Credit）。
一條 Q6 白金腿（必須為 #1 或 #2 多重事業的下線）可計入雙鑽及以上級別的寬度要求。
Q6 白金資格者亦可貢獻至資格積分（QC）統計。
如需進一步資訊，請洽您的市場聯絡窗口。
立即收看
```

**重要**：
- ✅ 顺序可以不一致
- ✅ 只需要是纯文本
- ❌ 不要包含占位符行

### 步骤 3: 智能匹配生成对照表

```bash
python3 ../scripts/generate_translation_mapping.py \
  --markdown extracted_table.md \
  --new-translations new_translations.txt \
  --output translations.json \
  --match-by smart \
  --verbose
```

### 步骤 4: 检查匹配结果

查看输出的匹配示例，确认配对是否正确。

特别注意低相似度的配对（< 15%）！

### 步骤 5: 应用翻译

```bash
python3 ../scripts/update_fc_insider_tracked.py \
  --input "/Users/hua/md腳本/FCInsider_Dec2025_Issue9_翻譯修訂版.docx" \
  --translations translations.json \
  --output "/Users/hua/md腳本/output_final.docx" \
  --author "Gemini" \
  --mode read_inserted \
  --verbose
```

---

## 💡 使用建议

### 1. 总是使用 `--verbose`

可以看到详细的匹配信息，帮助你确认配对是否正确。

### 2. 检查低相似度配对

相似度 < 15% 的配对可能不正确，建议手动检查。

### 3. 行数必须匹配

即使顺序可以不一致，新翻译的行数仍然必须与过滤后的表格行数一致。

### 4. 不要包含占位符

新翻译中不要包含占位符行（如 `"<0/>"在第 <1/> 頁`）。

---

## 🔧 调整相似度阈值

如果你想调整最小相似度阈值，可以修改脚本中的参数：

```python
# 在 generate_translation_mapping.py 中
new_translations = smart_match_translations(
    old_table,
    text_list,
    min_similarity=0.15,  # 调整这个值（0.0-1.0）
    verbose=args.verbose
)
```

- 提高阈值：更严格，会拒绝低相似度的配对
- 降低阈值：更宽松，接受更多配对

---

## ❓ FAQ

### Q: 智能匹配准确吗？

**A**: 对于翻译内容，通常非常准确（相似度 > 70%）。但建议：
1. 使用 `--verbose` 检查匹配示例
2. 特别注意低相似度的配对
3. 检查变更预览，确认配对正确

### Q: 如果两个翻译非常相似怎么办？

**A**: 智能匹配会选择相似度最高的配对，并确保每个翻译只被使用一次。

### Q: 可以处理完全不同的翻译吗？

**A**: 可以，但会警告相似度过低。建议检查这些配对。

### Q: 比 segment_id 匹配更好吗？

**A**:
- 如果你有准确的 segment_id 映射 → 使用 `segment_id`
- 如果顺序不一致，没有 segment_id 映射 → 使用 `smart`

### Q: 行数不匹配会怎样？

**A**: 如果新翻译行数多于旧翻译，会使用最佳匹配。但建议行数完全一致以获得最佳结果。

---

## ✅ 总结

1. **问题**：新翻译顺序与原表格不一致
2. **解决**：使用 `--match-by smart` 智能匹配
3. **优势**：
   - 顺序无关
   - 自动配对
   - 纯文本输入
   - 有容错能力
4. **建议**：
   - 使用 `--verbose` 查看详情
   - 检查低相似度配对
   - 验证变更预览

**这是处理顺序不一致问题的最佳方案！** 🎉
